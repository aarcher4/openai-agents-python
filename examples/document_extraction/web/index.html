<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Document Extraction Test</title>
    <style>
      body {
        background: #fff;
        font-family: Arial, sans-serif;
        padding: 40px;
      }

      .btn {
        background: #e0e0e0;
        color: #000;
        padding: 12px 16px;
        border: none;
        cursor: pointer;
        margin-right: 8px;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        min-width: 400px;
      }

      #bundleStatus {
        color: #666;
        font-style: italic;
      }

      #bundleStatus.error {
        color: #d00;
      }

      #bundleStatus.success {
        color: #090;
      }
    </style>
  </head>
  <body>
    <input id="file" type="file" style="display: none" />
    <button id="choose" class="btn">Upload file</button>
    <button id="start" class="btn" disabled>Start</button>
    <span id="status" style="margin-left: 12px"></span>
    <hr style="margin:24px 0" />
    <div id="bundles">
      <div style="margin-bottom:8px"><strong>Bundle Management</strong></div>
      <div style="margin-bottom:8px">
        <button id="refresh" class="btn">Refresh</button>
      </div>
      <div style="margin-bottom:8px">
        <label>Unassigned documents: </label>
        <select id="docSelect"></select>
      </div>
      <div style="margin-bottom:8px">
        <label><input type="radio" name="mode" value="create" checked> Create new bundle</label>
        <label style="margin-left:12px"><input type="radio" name="mode" value="add"> Add to existing bundle</label>
      </div>
      <div id="bundlePicker" style="display:none; margin-bottom:8px">
        <label>Existing bundles: </label>
        <select id="bundleSelect"></select>
      </div>
      <div>
        <button id="createBundle" class="btn">Create bundle</button>
        <button id="addToBundle" class="btn">Add to bundle</button>
        <span id="bundleStatus" style="margin-left: 12px"></span>
      </div>
    </div>
    <script>
      const fileInput = document.getElementById('file');
      const chooseBtn = document.getElementById('choose');
      const startBtn = document.getElementById('start');
      const status = document.getElementById('status');
      const refreshBtn = document.getElementById('refresh');
      const docSelect = document.getElementById('docSelect');
      const bundleSelect = document.getElementById('bundleSelect');
      const modeInputs = document.getElementsByName('mode');
      const bundlePicker = document.getElementById('bundlePicker');
      const createBundleBtn = document.getElementById('createBundle');
      const addToBundleBtn = document.getElementById('addToBundle');
      const bundleStatus = document.getElementById('bundleStatus');

      chooseBtn.onclick = () => fileInput.click();
      fileInput.onchange = () => {
        startBtn.disabled = !fileInput.files.length;
        status.textContent = fileInput.files.length ? fileInput.files[0].name : '';
      };

      startBtn.onclick = async () => {
        if (!fileInput.files.length) {
          return;
        }

        startBtn.disabled = true;
        chooseBtn.disabled = true;
        status.textContent = 'Uploading…';

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
          const response = await fetch('/api/upload-run', {
            method: 'POST',
            body: formData,
          });

          if (!response.ok) {
            throw new Error('Upload failed');
          }

          status.textContent = 'Done (check server console)';
        } catch (error) {
          status.textContent = 'Error: ' + error.message;
        } finally {
          startBtn.disabled = false;
          chooseBtn.disabled = false;
        }
      };

      function currentMode() {
        for (const m of modeInputs) { if (m.checked) return m.value; }
        return 'create';
      }

      modeInputs.forEach(m => {
        m.addEventListener('change', () => {
          bundlePicker.style.display = currentMode() === 'add' ? 'block' : 'none';
        });
      });

      async function loadUnassigned() {
        try {
          const res = await fetch('/api/documents/unassigned');
          if (!res.ok) throw new Error('Failed to load documents');
          const docs = await res.json();
          docSelect.innerHTML = '';
          
          if (!docs || docs.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '(No unassigned documents available)';
            opt.disabled = true;
            docSelect.appendChild(opt);
            createBundleBtn.disabled = true;
            addToBundleBtn.disabled = true;
          } else {
            createBundleBtn.disabled = false;
            addToBundleBtn.disabled = false;
            for (const d of docs) {
              const opt = document.createElement('option');
              opt.value = d.id;
              opt.textContent = `${d.id.slice(0,8)} · ${d.label}${d.po_number? ' · PO '+d.po_number : ''}${d.invoice_number? ' · INV '+d.invoice_number : ''}`;
              docSelect.appendChild(opt);
            }
          }
        } catch (e) {
          bundleStatus.textContent = 'Error loading documents: ' + e.message;
          bundleStatus.className = 'error';
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '(Error loading documents)';
          opt.disabled = true;
          docSelect.innerHTML = '';
          docSelect.appendChild(opt);
        }
      }

      async function loadBundles() {
        try {
          const res = await fetch('/api/bundles');
          if (!res.ok) throw new Error('Failed to load bundles');
          const bundles = await res.json();
          bundleSelect.innerHTML = '';
          
          if (!bundles || bundles.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '(No bundles available)';
            opt.disabled = true;
            bundleSelect.appendChild(opt);
          } else {
            for (const b of bundles) {
              const opt = document.createElement('option');
              opt.value = b.id;
              const label = b.key_po_number || b.key_invoice_number || 'Untitled';
              opt.textContent = `${b.id.slice(0,8)} · ${label} (${b.document_count || 0} docs)`;
              bundleSelect.appendChild(opt);
            }
          }
        } catch (e) {
          bundleStatus.textContent = 'Error loading bundles: ' + e.message;
          bundleStatus.className = 'error';
        }
      }

      async function refreshAll() {
        bundleStatus.textContent = 'Refreshing…';
        bundleStatus.className = '';
        await Promise.all([loadUnassigned(), loadBundles()]);
        bundleStatus.textContent = 'Refreshed';
        bundleStatus.className = 'success';
        setTimeout(() => { bundleStatus.textContent = ''; bundleStatus.className = ''; }, 2000);
      }

      refreshBtn.onclick = refreshAll;

      createBundleBtn.onclick = async () => {
        try {
          const id = docSelect.value;
          if (!id) {
            bundleStatus.textContent = 'Please select a document';
            bundleStatus.className = 'error';
            return;
          }
          bundleStatus.textContent = 'Creating bundle…';
          bundleStatus.className = '';
          const res = await fetch('/api/bundles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ document_id: id })
          });
          const body = await res.json();
          if (!res.ok) throw new Error(body.detail || 'Create failed');
          bundleStatus.textContent = 'Created bundle ' + body.bundle_id.slice(0,8);
          bundleStatus.className = 'success';
          await refreshAll();
        } catch (e) {
          bundleStatus.textContent = 'Error: ' + e.message;
          bundleStatus.className = 'error';
        }
      };

      addToBundleBtn.onclick = async () => {
        try {
          const id = docSelect.value;
          const bundleId = bundleSelect.value;
          if (!id || !bundleId) {
            bundleStatus.textContent = 'Please select a document and bundle';
            bundleStatus.className = 'error';
            return;
          }
          bundleStatus.textContent = 'Adding…';
          bundleStatus.className = '';
          const res = await fetch(`/api/bundles/${bundleId}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ document_id: id })
          });
          const body = await res.json();
          if (!res.ok) throw new Error(body.detail || 'Add failed');
          bundleStatus.textContent = 'Added to bundle';
          bundleStatus.className = 'success';
          await refreshAll();
        } catch (e) {
          bundleStatus.textContent = 'Error: ' + e.message;
          bundleStatus.className = 'error';
        }
      };

      // Initial load
      refreshAll();
    </script>
  </body>
</html>

